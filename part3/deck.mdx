export { theme } from './config'
import {
  CodeSurferLayout,
  CodeSurferColumnLayout,
} from "code-surfer";
import {
  Invert,
  Split,
  SplitRight,
  Horizontal,
  FullScreenCode,
} from '@mdx-deck/layouts';
import { Appear, Image } from 'mdx-deck';
import { CenteredImages, BaseSlide, BigFont, ReadSlide } from './config'

<Image
  src="images/fastify.png"
  style={{
    display: 'flex',
    justifyContent: 'center',
    alignItems: 'center',
    color: '#fff',
    flexDirection: 'column',
    fontSize: '4rem',
    fontWeight: 900
  }}
>

</Image>

---

<SplitRight>

<img
  src="images/matteo.jpg"
  style={{
    top: 0,
    width: '100%',
    height: '100vh',
    objectPosition: 'center'
  }}
/>

## Matteo Collina
Technical Director @NearForm

</SplitRight>

---

<SplitRight>

<img
  src="images/thomas.jpg"
  style={{
    top: 0,
    width: '100%',
    height: '100vh',
    objectPosition: 'center'
  }}
/>

## Thomas della Vedova
Software Architect @elastic

</SplitRight>

---

<BaseSlide>
  <h1>Core Team</h1>
  <CenteredImages>
    <div className="avatar">
      <img src="https://avatars3.githubusercontent.com/u/52195?s=400&v=4" />
      <h6>Matteo Collina</h6>
    </div>
    <div className="avatar">
      <img src="https://avatars2.githubusercontent.com/u/4865608?s=400&v=4" />
      <h6>Thomas Della Vedova</h6>
    </div>
    <div className="avatar">
      <img src="https://avatars2.githubusercontent.com/u/1054125?s=400&v=4" />
      <h6>Tommaso Allevo</h6>
    </div>
    <div className="avatar">
      <img src="https://avatars2.githubusercontent.com/u/16144158?s=400&v=4" />
      <h6>Ethan Arrowood</h6>
    </div>
    <div className="avatar">
      <img src="https://avatars3.githubusercontent.com/u/1297759?s=400&v=4" />
      <h6>Cemre Mengu</h6>
    </div>
    <div className="avatar">
      <img src="https://avatars1.githubusercontent.com/u/1764424?s=400&v=4" />
      <h6>Dustin Deus</h6>
    </div>
    <div className="avatar">
      <img src="https://avatars1.githubusercontent.com/u/205629?s=400&v=4" />
      <h6>Luciano Mammino</h6>
    </div>
    <div className="avatar">
      <img src="https://avatars3.githubusercontent.com/u/1303687?s=400&v=4" />
      <h6>Evan Shortiss</h6>
    </div>
    <div className="avatar">
      <img src="https://avatars2.githubusercontent.com/u/11404065?s=400&v=4" />
      <h6>Manuel Spigolon</h6>
    </div>
    <div className="avatar">
      <img src="https://avatars2.githubusercontent.com/u/321201?s=400&v=4" />
      <h6>James Sumners</h6>
    </div>
    <div className="avatar">
      <img src="https://avatars1.githubusercontent.com/u/5128013?s=400&v=4" />
      <h6>Nathan Woltman</h6>
    </div>
  </CenteredImages>
</BaseSlide>

---

<BigFont>
  <h1>2000+</h1>
  <span className="subtitle">COMMITS</span>
</BigFont>

---

<BigFont>
  <h1>120+</h1>
  <span className="subtitle">RELEASES</span>
</BigFont>

---

<BigFont>
  <h1>180+</h1>
  <span className="subtitle">COLLABORATORS</span>
</BigFont>

---

<BigFont>
  <h1>110+</h1>
  <span className="subtitle">PLUGINS</span>
</BigFont>

---

<BigFont>
  <h1>Why Fastify?</h1>
</BigFont>

---

<BigFont>
  <img src="./images/fastify_bench.png" />
</BigFont>

---

<BigFont>
  <code>fast-json-stringify</code>
</BigFont>

---
<CodeSurferLayout>

```js subtitle="2x faster than JSON.stringify()"
const fastJson = require('fast-json-stringify')

const stringify = fastJson({
  title: 'Example Schema',
  type: 'object',
  properties: {
    firstName: {
      type: 'string'
    },
    lastName: {
      type: 'string'
    },
    age: {
      description: 'Age in years',
      type: 'integer'
    }
  }
})
```

```js subtitle="Its performance advantage shrinks as your payload grows"
console.log(stringify({
  firstName: "Davide",
  lastName: "D'Antonio",
  age: 35
}))
```

</CodeSurferLayout>

---

<BigFont>
  <code>find-my-way</code>
</BigFont>

---

<CodeSurferLayout>

```js subtitle="A crazy fast HTTP router. Used by Netflix"
const http = require('http')
const router = require('find-my-way')()

router.on('GET', '/', (req, res, params) => {
  res.end('{"message":"hello world"}')
})

const server = http.createServer((req, res) => {
  router.lookup(req, res)
})
```

</CodeSurferLayout>

---

<BigFont>
  <span className="subtitle">Extendible via </span>
  <span className="colored">plugins</span>
</BigFont>

---

<CodeSurferLayout>

```js
fastify.register(
  require('my-plugin'),
  { options }
)
```

</CodeSurferLayout>

---

<CodeSurferLayout>

```js subtitle="Plugins must expose a single function with the following signature"
module.exports = function (fastify, options, next) {}
```

</CodeSurferLayout>

---

<BaseSlide>
  <code>module.exports = function (fastify, options, next) {}</code>
  <ul>
    <li><strong>fastify</strong>: the encapsulated fastify instance</li>
    <li><strong>options</strong>: the plugin options</li>
    <li><strong>next</strong>: is the function that will be called when the plugin has been correctly loaded</li>
  </ul>
</BaseSlide>

---

<CodeSurferLayout>

```js subtitle="async await is supported"
function myPlugin (fastify, opts, next) {
  // add another plugin
  fastify.register (...)

  // add an Hook
  fastify.addHook(...)

  // decorate fastify instance
  fastify.decorate(...)

  // add routes
  fastify.route(...)

  next()
}

module.exports = myPlugin
```

</CodeSurferLayout>

---

<BigFont>
  <img src="./images/plugin_dag_1.png" />
</BigFont>

---

<BigFont>
  <code>fastify-plugin</code>
</BigFont>

---

<CodeSurferLayout>

```js subtitle="How to use fastify-plugin to expose plugin to the parent"
const fp = require('fastify-plugin')
const myPlugin2 = require('myPlugin2')

function myPlugin (fastify, opts, next) {
  fastify.decorate('myPlugin2', myPlugin2)
  next()
}

module.exports = fp(myPlugin)
```

</CodeSurferLayout>

---

<BigFont>
  <img src="./images/plugin_dag_2.png" />
</BigFont>

---

<BigFont>
  <img src="./images/plugin_dag_3.png" />
</BigFont>

---

<CodeSurferLayout>

```js title="Encapsulation is the keystone of fastify" subtitle="For example, allows us to have different logs levels for each plugin"
const fastify = require('fastify')()

fastify.register(require('./api/v1'), {
  prefix: '/v1',
  logLevel: 'error'
})

fastify.register(require('./api/v2'), {
  prefix: '/v2',
  logLevel: 'debug'
})
```

</CodeSurferLayout>

---

<BigFont>
  <img src="./images/pino_logo.png" />
  <h2>Pino</h2>
</BigFont>

---

<CodeSurferLayout>

```js title="Logging is disabled by default" subtitle="you can enable it by passing {logger: true} or {logger: { level: 'info' }}"
const fastify = require('fastify')({
  logger: true
})

fastify.get('/', options, function (request, reply) {
  request.log.info('Some info about the current request')
  reply.send({ hello: 'world' })
})

```

```js subtitle="If you want to specify a file destination"
const fastify = require('fastify')({
  logger: {
    level: 'info',
    file: '/path/to/file' // will use pino.destination()
  }
})

fastify.get('/', options, function (request, reply) {
  request.log.info('Some info about the current request')
  reply.send({ hello: 'world' })
})
```

</CodeSurferLayout>

---

<CodeSurferLayout>

```js subtitle="You can specify a log level"
fastify.log.trace('Trace level log')
fastify.log.debug('Debug level log')
fastify.log.info('Info level log')
fastify.log.warn('Warning level log')
fastify.log.error('Error level log')
fastify.log.fatal('Fatal level log')
```

</CodeSurferLayout>

---

<BigFont>
  <h1>Hooks</h1>
</BigFont>

---

<ReadSlide>
  <h1>Request/Response Hooks</h1>
  <p>
    By using the hooks you can interact directly inside the lifecycle of Fastify.<br />
    There are seven different Hooks that you can use (in order of execution):
  </p>
  <p>
    <ul>
    <li><strong>onRequest</strong></li>
    <li><strong>preParsing</strong></li>
    <li><strong>preValidation</strong></li>
    <li><strong>preHandler</strong></li>
    <li><strong>preSerialization</strong></li>
    <li><strong>onError</strong></li>
    <li><strong>onSend</strong></li>
    <li><strong>onResponse</strong></li>
  </ul>
  </p>
</ReadSlide>

---

<CodeSurferLayout>

```js title="onError hook "
fastify.addHook('onError', (request, reply, error, next) => {
  // apm stands for Application Performance Monitoring
  apm.sendError(error)
  next()
})
````

</CodeSurferLayout>

---

<CodeSurferLayout>

```js title="preSerialization hook" subtitle="you can change (or replace) the payload before it is serialized"
fastify.addHook('preSerialization', (request, reply, payload, next) => {
  var err = null;
  var newPayload = {wrapped: payload }
  next(err, newPayload)
})
````

</CodeSurferLayout>

---

<CodeSurferLayout>

```js title="onSend hook" subtitle="If you are using the onSend hook, you can change the payload"
fastify.addHook('onSend', (request, reply, payload, next) => {
  var err = null;
  var newPayload = payload.replace('some-text', 'some-new-text')
  next(err, newPayload)
})
````

</CodeSurferLayout>

---

<CodeSurferLayout>

```js title="preSerialization hook" subtitle="You can change (or replace) the payload before it is serialized"
fastify.addHook('preSerialization', (request, reply, payload, done) => {
  var err = null;
  var newPayload = { wrapped: payload }
  done(err, newPayload)
})
````

</CodeSurferLayout>

---

<ReadSlide>
  <h1>Application Hooks</h1>
  <p>
    You are able to hook into the application-lifecycle as well. It's important to note that these hooks aren't fully encapsulated. The this inside the hooks are encapsulated but the handlers can respond to an event outside the encapsulation boundaries.
  </p>
  <p>
    <ul>
    <li><strong>onClose</strong></li>
    <li><strong>onRoute</strong></li>
  </ul>
  </p>
</ReadSlide>

---

<CodeSurferLayout>

```js title="onClose hook" subtitle="Triggered when fastify.close() is invoked to stop the server"
fastify.addHook('onClose', (instance, done) => {
  // some code
  done()
})
````

</CodeSurferLayout>

---

<CodeSurferLayout>

```js title="onRoute hook" subtitle="Triggered when a new route is registered"
fastify.addHook('onRoute', (routeOptions) => {
  // some code
  routeOptions.method
  routeOptions.schema
  routeOptions.url
  routeOptions.bodyLimit
  routeOptions.logLevel
  routeOptions.prefix
})
````

</CodeSurferLayout>

---

<CodeSurferLayout>

```js title="Route level hooks"
fastify.addHook('preValidation', (request, reply, done) => {
  // your code
  done()
})

fastify.addHook('preHandler', (request, reply, done) => {
  // your code
  done()
})

fastify.route({
  method: 'GET',
  url: '/',
  schema: { ... },
  preValidation: function (request, reply, done) {
    // this hook will always be executed after the shared `preValidation` hooks
    done()
  },
  preHandler: function (request, reply, done) {
    // this hook will always be executed after the shared `preHandler` hooks
    done()
  },
  handler: function (request, reply) {
    reply.send({ hello: 'world' })
  }
})
```

</CodeSurferLayout>